{% extends "base.html" %}
{% block title %}Leyes de Gestalt{% endblock %}

{% block content %}
  <div class="topic-header gestalt-header">
    <h2>üëÅÔ∏è Leyes de Gestalt üëÅÔ∏è</h2>
    <p>¬°Descubre c√≥mo nuestro cerebro organiza lo que vemos!</p>
  </div>

  <div class="topic-content">
    <section class="info-section">
      <h3>¬øQu√© son las Leyes de Gestalt?</h3>
      <p>Las Leyes de Gestalt son como reglas que explican c√≥mo nuestro cerebro agrupa y organiza las cosas que vemos. Estas reglas nos ayudan a dise√±ar interfaces que sean f√°ciles de entender para todos.</p>
      
      <div class="gestalt-intro">
        <img src="{{ url_for('static', filename='images/gestalt_intro.png') }}" alt="Ejemplo de Gestalt" class="gestalt-image">
        <p>Nuestro cerebro ve patrones y grupos, no solo elementos individuales.</p>
      </div>
    </section>

    <section class="info-section">
      <h3>Ley de Proximidad</h3>
      <div class="gestalt-example">
        <div class="gestalt-demo proximity-demo">
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          
          <div class="spacer"></div>
          
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
          <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>
        <div class="gestalt-explanation">
          <p>Los elementos que est√°n cerca entre s√≠ se perciben como un grupo.</p>
          <p>En programaci√≥n, colocamos juntos los botones o elementos que tienen funciones relacionadas.</p>
        </div>
      </div>
    </section>

    <section class="info-section">
      <h3>Ley de Similitud</h3>
      <div class="gestalt-example">
        <div class="gestalt-demo similarity-demo">
          <div class="square"></div><div class="circle"></div><div class="square"></div>
          <div class="circle"></div><div class="square"></div><div class="circle"></div>
          <div class="square"></div><div class="circle"></div><div class="square"></div>
        </div>
        <div class="gestalt-explanation">
          <p>Los elementos que se parecen se perciben como parte del mismo grupo.</p>
          <p>En programaci√≥n, usamos colores y formas similares para elementos que tienen la misma funci√≥n.</p>
        </div>
      </div>
    </section>

    <section class="info-section">
      <h3>Ley de Cierre</h3>
      <div class="gestalt-example">
        <div class="gestalt-demo closure-demo">
          <div class="incomplete-circle"></div>
          <div class="incomplete-square"></div>
          <div class="incomplete-triangle"></div>
        </div>
        <div class="gestalt-explanation">
          <p>Nuestro cerebro completa las formas incompletas.</p>
          <p>En programaci√≥n, podemos usar formas incompletas y el usuario a√∫n entender√° lo que son.</p>
        </div>
      </div>
    </section>

    <section class="info-section">
      <h3>Ley de Continuidad</h3>
      <div class="gestalt-example">
        <div class="gestalt-demo continuity-demo">
          <svg width="300" height="100">
            <path d="M10,50 Q75,10 150,50 T290,50" stroke="blue" fill="transparent" stroke-width="3"/>
            <path d="M10,50 Q75,90 150,50 T290,50" stroke="red" fill="transparent" stroke-width="3"/>
          </svg>
        </div>
        <div class="gestalt-explanation">
          <p>Nuestro cerebro sigue l√≠neas y curvas de manera natural.</p>
          <p>En programaci√≥n, usamos l√≠neas y flechas para guiar al usuario a trav√©s de la interfaz.</p>
        </div>
      </div>
    </section>

    <section class="info-section">
      <h3>Ley de Figura y Fondo</h3>
      <div class="gestalt-example">
        <div class="gestalt-demo figure-ground-demo">
          <img src="{{ url_for('static', filename='images/figure_ground.png') }}" alt="Figura y fondo" class="gestalt-image">
        </div>
        <div class="gestalt-explanation">
          <p>Nuestro cerebro distingue entre un objeto principal (figura) y su entorno (fondo).</p>
          <p>En programaci√≥n, usamos contraste y espacio para destacar elementos importantes.</p>
        </div>
      </div>
    </section>

    <section class="interactive-section">
      <h3>¬°Juega con Gestalt!</h3>
      <div class="gestalt-interactive">
        <div class="interactive-container">
          <div class="gestalt-playground" id="gestalt-playground">
            <!-- Los elementos se agregar√°n con JavaScript -->
          </div>
          <div class="interactive-controls">
            <button id="proximity-btn">Proximidad</button>
            <button id="similarity-btn">Similitud</button>
            <button id="closure-btn">Cierre</button>
            <button id="continuity-btn">Continuidad</button>
            <button id="figure-ground-btn">Figura y Fondo</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Nueva secci√≥n: Actividades interactivas -->
    <section class="activities-section">
      <h3>üéÆ Actividades Interactivas</h3>
      
      <!-- Actividad 1: Adivina la Ley -->
      <div class="activity-card">
        <h4>üß© Adivina la Ley</h4>
        <div class="activity-content">
          <div class="guess-law-game">
            <div class="game-image-container">
              <img id="guess-law-image" src="{{ url_for('static', filename='images/gestalt_proximity.png') }}" alt="Adivina la ley" class="game-image">
            </div>
            <p>¬øQu√© ley de Gestalt se aplica en esta imagen?</p>
            <div class="game-options">
              <button class="game-option" data-law="continuidad">A. Continuidad</button>
              <button class="game-option" data-law="proximidad">B. Proximidad</button>
              <button class="game-option" data-law="cierre">C. Cierre</button>
            </div>
            <p id="guess-law-feedback" class="game-feedback"></p>
            <button id="next-image" class="next-btn" style="display: none;">Siguiente imagen</button>
          </div>
        </div>
      </div>
      
      <!-- Actividad 2: Dibuja con Gestalt -->
      <div class="activity-card">
        <h4>üé® Dibuja con Gestalt</h4>
        <div class="activity-content">
          <div class="draw-gestalt-game">
            <p>Arrastra y coloca elementos para crear un patr√≥n que represente una ley de Gestalt:</p>
            <div class="drawing-tools">
              <button class="tool-btn" data-shape="dot">Punto</button>
              <button class="tool-btn" data-shape="square">Cuadrado</button>
              <button class="tool-btn" data-shape="circle">C√≠rculo</button>
              <button class="tool-btn" data-shape="line">L√≠nea</button>
            </div>
            <div class="drawing-canvas" id="drawing-canvas">
              <!-- Los elementos se agregar√°n con JavaScript -->
            </div>
            <div class="drawing-controls">
              <button id="clear-canvas">Borrar todo</button>
              <div class="law-selector">
                <label for="law-select">¬øQu√© ley est√°s representando?</label>
                <select id="law-select">
                  <option value="">Selecciona una ley...</option>
                  <option value="proximidad">Proximidad</option>
                  <option value="similitud">Similitud</option>
                  <option value="cierre">Cierre</option>
                  <option value="continuidad">Continuidad</option>
                  <option value="figura-fondo">Figura y Fondo</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Actividad 3: Encuentra la figura oculta -->
      <div class="activity-card">
        <h4>üëÅÔ∏è Encuentra la figura oculta</h4>
        <div class="activity-content">
          <div class="hidden-figure-game">
            <p>¬øPuedes encontrar la figura oculta en esta imagen? ¬°Haz clic cuando la veas!</p>
            <div class="figure-container">
              <img id="hidden-figure" src="{{ url_for('static', filename='images/hidden_figure.png') }}" alt="Figura oculta" class="hidden-figure-image">
              <div id="figure-highlight" class="figure-highlight"></div>
            </div>
            <button id="reveal-figure" class="reveal-btn">Revelar figura</button>
            <p id="hidden-figure-feedback" class="game-feedback"></p>
          </div>
        </div>
      </div>
      
      <!-- Actividad 4: Completa el dibujo -->
      <div class="activity-card">
        <h4>üß† Completa el dibujo</h4>
        <div class="activity-content">
          <div class="complete-drawing-game">
            <p>Nuestro cerebro puede completar formas autom√°ticamente. ¬°Dibuja las l√≠neas que faltan!</p>
            <div class="incomplete-drawing-container">
              <canvas id="drawing-canvas-completion" width="400" height="300"></canvas>
            </div>
            <div class="drawing-controls">
              <button id="check-completion">Comprobar</button>
              <button id="next-incomplete">Siguiente dibujo</button>
            </div>
            <p id="completion-feedback" class="game-feedback"></p>
          </div>
        </div>
      </div>
      
      <!-- Actividad 5: Conecta los puntos -->
      <div class="activity-card">
        <h4>üßµ Conecta los puntos</h4>
        <div class="activity-content">
          <div class="connect-dots-game">
            <p>Sigue la ley de continuidad para conectar los puntos en el orden correcto.</p>
            <div class="dots-container">
              <canvas id="dots-canvas" width="400" height="300"></canvas>
            </div>
            <div class="dots-controls">
              <button id="check-dots">Comprobar</button>
              <button id="reset-dots">Reiniciar</button>
            </div>
            <p id="dots-feedback" class="game-feedback"></p>
          </div>
        </div>
      </div>
      
      <!-- Actividad 6: Clasifica por semejanza -->
      <div class="activity-card">
        <h4>üí° Clasifica por semejanza</h4>
        <div class="activity-content">
          <div class="classify-game">
            <p>Arrastra y agrupa los elementos similares (por color, forma o tama√±o).</p>
            <div class="classification-container">
              <div id="elements-container" class="elements-container">
                <!-- Los elementos se agregar√°n con JavaScript -->
              </div>
              <div id="drop-zones" class="drop-zones">
                <div class="drop-zone" data-group="1"></div>
                <div class="drop-zone" data-group="2"></div>
                <div class="drop-zone" data-group="3"></div>
              </div>
            </div>
            <div class="classification-controls">
              <button id="check-classification">Comprobar</button>
              <button id="reset-classification">Reiniciar</button>
            </div>
            <p id="classification-feedback" class="game-feedback"></p>
          </div>
        </div>
      </div>
      
      <!-- Actividad 7: Memorama de leyes -->
      <div class="activity-card">
        <h4>üî§ Memorama de leyes</h4>
        <div class="activity-content">
          <div class="memory-game">
            <p>Encuentra las parejas: imagen y nombre de la ley correspondiente.</p>
            <div class="memory-board" id="memory-board">
              <!-- Las cartas se agregar√°n con JavaScript -->
            </div>
            <div class="memory-stats">
              <p>Intentos: <span id="memory-attempts">0</span></p>
              <p>Parejas encontradas: <span id="memory-matches">0</span>/6</p>
            </div>
            <button id="reset-memory" class="reset-btn">Reiniciar juego</button>
          </div>
        </div>
      </div>
    </section>

    <section class="quiz-section">
      <h3>¬°Pon a prueba tus conocimientos!</h3>
      <div class="quiz-container">
        <div class="quiz-question">
          <p>¬øQu√© ley de Gestalt explica por qu√© vemos un c√≠rculo aunque est√© incompleto?</p>
          <div class="quiz-options">
            <button class="quiz-option" data-correct="false">Ley de Proximidad</button>
            <button class="quiz-option" data-correct="false">Ley de Similitud</button>
            <button class="quiz-option" data-correct="true">Ley de Cierre</button>
            <button class="quiz-option" data-correct="false">Ley de Continuidad</button>
          </div>
          <p class="quiz-feedback"></p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // Interactive Gestalt playground
    const playground = document.getElementById('gestalt-playground');
    const proximityBtn = document.getElementById('proximity-btn');
    const similarityBtn = document.getElementById('similarity-btn');
    const closureBtn = document.getElementById('closure-btn');
    const continuityBtn = document.getElementById('continuity-btn');
    const figureGroundBtn = document.getElementById('figure-ground-btn');

    // Proximity demonstration
    proximityBtn.addEventListener('click', function() {
      playground.innerHTML = '';
      playground.className = 'gestalt-playground proximity-playground';
      
      for (let i = 0; i < 20; i++) {
        const dot = document.createElement('div');
        dot.className = 'playground-dot';
        playground.appendChild(dot);
      }
    });

    // Similarity demonstration
    similarityBtn.addEventListener('click', function() {
      playground.innerHTML = '';
      playground.className = 'gestalt-playground similarity-playground';
      
      for (let i = 0; i < 16; i++) {
        const shape = document.createElement('div');
        shape.className = i % 2 === 0 ? 'playground-square' : 'playground-circle';
        playground.appendChild(shape);
      }
    });

    // Closure demonstration
    closureBtn.addEventListener('click', function() {
      playground.innerHTML = '';
      playground.className = 'gestalt-playground closure-playground';
      
      const shapes = ['incomplete-circle-large', 'incomplete-square-large', 'incomplete-triangle-large'];
      
      for (let i = 0; i < shapes.length; i++) {
        const shape = document.createElement('div');
        shape.className = shapes[i];
        playground.appendChild(shape);
      }
    });

    // Continuity demonstration
    continuityBtn.addEventListener('click', function() {
      playground.innerHTML = '';
      playground.className = 'gestalt-playground continuity-playground';
      
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.setAttribute('viewBox', '0 0 300 150');
      
      const path1 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path1.setAttribute('d', 'M10,75 Q75,25 150,75 T290,75');
      path1.setAttribute('stroke', '#FF5722');
      path1.setAttribute('fill', 'transparent');
      path1.setAttribute('stroke-width', '4');
      
      const path2 = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path2.setAttribute('d', 'M10,75 Q75,125 150,75 T290,75');
      path2.setAttribute('stroke', '#2196F3');
      path2.setAttribute('fill', 'transparent');
      path2.setAttribute('stroke-width', '4');
      
      svg.appendChild(path1);
      svg.appendChild(path2);
      playground.appendChild(svg);
    });

    // Figure-ground demonstration
    figureGroundBtn.addEventListener('click', function() {
      playground.innerHTML = '';
      playground.className = 'gestalt-playground figure-ground-playground';
      
      const img = document.createElement('img');
      img.src = "{{ url_for('static', filename='images/figure_ground_interactive.png') }}";
      img.alt = "Figura y fondo interactivo";
      img.className = "figure-ground-interactive";
      playground.appendChild(img);
    });

    // Initialize with proximity example
    proximityBtn.click();

    // Quiz functionality
    const quizOptions = document.querySelectorAll('.quiz-option');
    const quizFeedback = document.querySelector('.quiz-feedback');

    quizOptions.forEach(option => {
      option.addEventListener('click', function() {
        quizOptions.forEach(btn => btn.disabled = true);
        
        if (this.dataset.correct === 'true') {
          this.classList.add('correct');
          quizFeedback.textContent = '¬°Correcto! ¬°Muy bien!';
          quizFeedback.style.color = '#4CAF50';
        } else {
          this.classList.add('incorrect');
          quizFeedback.textContent = 'Incorrecto. Intenta de nuevo.';
          quizFeedback.style.color = '#F44336';
          
          // Highlight the correct answer
          quizOptions.forEach(btn => {
            if (btn.dataset.correct === 'true') {
              btn.classList.add('correct');
            }
          });
        }
      });
    });

    // Adivina la Ley game
    const guessLawImage = document.getElementById('guess-law-image');
    const guessLawOptions = document.querySelectorAll('.guess-law-game .game-option');
    const guessLawFeedback = document.getElementById('guess-law-feedback');
    const nextImageBtn = document.getElementById('next-image');

    // Im√°genes para el juego
    const lawImages = [
      {
        src: "{{ url_for('static', filename='images/gestalt_proximity.png') }}",
        law: "proximidad"
      },
      {
        src: "{{ url_for('static', filename='images/gestalt_similarity.png') }}",
        law: "similitud"
      },
      {
        src: "{{ url_for('static', filename='images/gestalt_closure.png') }}",
        law: "cierre"
      },
      {
        src: "{{ url_for('static', filename='images/gestalt_continuity.png') }}",
        law: "continuidad"
      },
      {
        src: "{{ url_for('static', filename='images/gestalt_figure_ground.png') }}",
        law: "figura-fondo"
      }
    ];

    let currentImageIndex = 0;

    // Funci√≥n para cargar la siguiente imagen
    function loadNextImage() {
      if (currentImageIndex >= lawImages.length) {
        currentImageIndex = 0;
      }
      
      guessLawImage.src = lawImages[currentImageIndex].src;
      guessLawFeedback.textContent = '';
      guessLawFeedback.style.color = '';
      nextImageBtn.style.display = 'none';
      
      guessLawOptions.forEach(option => {
        option.disabled = false;
        option.classList.remove('correct', 'incorrect');
      });
    }

    // Event listeners para las opciones
    guessLawOptions.forEach(option => {
      option.addEventListener('click', function() {
        guessLawOptions.forEach(btn => btn.disabled = true);
        
        if (this.dataset.law === lawImages[currentImageIndex].law) {
          this.classList.add('correct');
          guessLawFeedback.textContent = '¬°Correcto! ‚úÖ';
          guessLawFeedback.style.color = '#4CAF50';
        } else {
          this.classList.add('incorrect');
          guessLawFeedback.textContent = 'Incorrecto. ‚ùå La respuesta correcta es: ' + 
            lawImages[currentImageIndex].law.charAt(0).toUpperCase() + 
            lawImages[currentImageIndex].law.slice(1);
          guessLawFeedback.style.color = '#F44336';
          
          // Highlight the correct answer
          guessLawOptions.forEach(btn => {
            if (btn.dataset.law === lawImages[currentImageIndex].law) {
              btn.classList.add('correct');
            }
          });
        }
        
        nextImageBtn.style.display = 'block';
      });
    });

    // Event listener para el bot√≥n de siguiente imagen
    nextImageBtn.addEventListener('click', function() {
      currentImageIndex++;
      loadNextImage();
    });

    // Dibuja con Gestalt
    const drawingCanvas = document.getElementById('drawing-canvas');
    const toolButtons = document.querySelectorAll('.tool-btn');
    const clearCanvasBtn = document.getElementById('clear-canvas');
    let currentTool = null;

    // Event listeners para las herramientas
    toolButtons.forEach(button => {
      button.addEventListener('click', function() {
        toolButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentTool = this.dataset.shape;
      });
    });

    // Event listener para el canvas
    drawingCanvas.addEventListener('click', function(e) {
      if (!currentTool) return;
      
      const rect = drawingCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const element = document.createElement('div');
      element.className = `drawing-element ${currentTool}-element`;
      element.style.left = `${x}px`;
      element.style.top = `${y}px`;
      
      drawingCanvas.appendChild(element);
    });

    // Event listener para borrar el canvas
    clearCanvasBtn.addEventListener('click', function() {
      drawingCanvas.innerHTML = '';
    });

    // Encuentra la figura oculta
    const hiddenFigure = document.getElementById('hidden-figure');
    const figureHighlight = document.getElementById('figure-highlight');
    const revealFigureBtn = document.getElementById('reveal-figure');
    const hiddenFigureFeedback = document.getElementById('hidden-figure-feedback');

    // Event listener para revelar la figura
    revealFigureBtn.addEventListener('click', function() {
      figureHighlight.style.display = 'block';
      hiddenFigureFeedback.textContent = '¬°Has encontrado la figura! Esta es una aplicaci√≥n de la ley de Figura y Fondo.';
      hiddenFigureFeedback.style.color = '#4CAF50';
    });

    // Completa el dibujo
    const completionCanvas = document.getElementById('drawing-canvas-completion');
    const ctx = completionCanvas.getContext('2d');
    const checkCompletionBtn = document.getElementById('check-completion');
    const nextIncompleteBtn = document.getElementById('next-incomplete');
    const completionFeedback = document.getElementById('completion-feedback');
    
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    // Dibujos incompletos
    const incompleteDrawings = [
      {
        draw: function() {
          ctx.clearRect(0, 0, completionCanvas.width, completionCanvas.height);
          ctx.beginPath();
          ctx.moveTo(100, 100);
          ctx.lineTo(300, 100);
          ctx.lineTo(300, 200);
          ctx.stroke();
        },
        solution: [
          [100, 100],
          [100, 200],
          [300, 200]
        ]
      },
      {
        draw: function() {
          ctx.clearRect(0, 0, completionCanvas.width, completionCanvas.height);
          ctx.beginPath();
          ctx.arc(200, 150, 50, 0, Math.PI, false);
          ctx.stroke();
        },
        solution: [
          [200, 150],
          [200, 200]
        ]
      }
    ];
    
    let currentDrawingIndex = 0;
    
    // Funci√≥n para cargar el siguiente dibujo incompleto
    function loadNextIncompleteDrawing() {
      if (currentDrawingIndex >= incompleteDrawings.length) {
        currentDrawingIndex = 0;
      }
      
      incompleteDrawings[currentDrawingIndex].draw();
      completionFeedback.textContent = '';
    }
    
    // Event listeners para el canvas de dibujo
    completionCanvas.addEventListener('mousedown', function(e) {
      isDrawing = true;
      const rect = completionCanvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    });
    
    completionCanvas.addEventListener('mousemove', function(e) {
      if (!isDrawing) return;
      
      const rect = completionCanvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;
      
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(currentX, currentY);
      ctx.stroke();
      
      lastX = currentX;
      lastY = currentY;
    });
    
    completionCanvas.addEventListener('mouseup', function() {
      isDrawing = false;
    });
    
    completionCanvas.addEventListener('mouseout', function() {
      isDrawing = false;
    });
    
    // Event listener para comprobar el dibujo
    checkCompletionBtn.addEventListener('click', function() {
      completionFeedback.textContent = '¬°Buen trabajo! Has completado el dibujo aplicando la ley de cierre.';
      completionFeedback.style.color = '#4CAF50';
    });
    
    // Event listener para el siguiente dibujo
    nextIncompleteBtn.addEventListener('click', function() {
      currentDrawingIndex++;
      loadNextIncompleteDrawing();
    });
    
    // Inicializar el primer dibujo
    loadNextIncompleteDrawing();

    // Conecta los puntos
    const dotsCanvas = document.getElementById('dots-canvas');
    const dotsCtx = dotsCanvas.getContext('2d');
    const checkDotsBtn = document.getElementById('check-dots');
    const resetDotsBtn = document.getElementById('reset-dots');
    const dotsFeedback = document.getElementById('dots-feedback');
    
    // Puntos para conectar
    const dots = [
      {x: 50, y: 50, connected: false},
      {x: 100, y: 70, connected: false},
      {x: 150, y: 90, connected: false},
      {x: 200, y: 110, connected: false},
      {x: 250, y: 130, connected: false},
      {x: 300, y: 150, connected: false}
    ];
    
    let selectedDot = null;
    let connectedDots = [];
    
    // Funci√≥n para dibujar los puntos
    function drawDots() {
      dotsCtx.clearRect(0, 0, dotsCanvas.width, dotsCanvas.height);
      
      // Dibujar l√≠neas entre puntos conectados
      if (connectedDots.length > 1) {
        dotsCtx.beginPath();
        dotsCtx.moveTo(connectedDots[0].x, connectedDots[0].y);
        
        for (let i = 1; i < connectedDots.length; i++) {
          dotsCtx.lineTo(connectedDots[i].x, connectedDots[i].y);
        }
        
        dotsCtx.stroke();
      }
      
      // Dibujar puntos
      dots.forEach(dot => {
        dotsCtx.beginPath();
        dotsCtx.arc(dot.x, dot.y, 10, 0, Math.PI * 2);
        dotsCtx.fillStyle = dot.connected ? '#4CAF50' : '#5a9bff';
        dotsCtx.fill();
      });
    }
    
    // Event listener para el canvas de puntos
    dotsCanvas.addEventListener('click', function(e) {
      const rect = dotsCanvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      
      // Comprobar si se hizo clic en un punto
      dots.forEach(dot => {
        const distance = Math.sqrt(Math.pow(clickX - dot.x, 2) + Math.pow(clickY - dot.y, 2));
        
        if (distance < 15) {
          dot.connected = true;
          connectedDots.push(dot);
          drawDots();
        }
      });
    });
    
    // Event listener para comprobar la conexi√≥n
    checkDotsBtn.addEventListener('click', function() {
      if (connectedDots.length === dots.length) {
        dotsFeedback.textContent = '¬°Excelente! Has conectado todos los puntos siguiendo la ley de continuidad.';
        dotsFeedback.style.color = '#4CAF50';
      } else {
        dotsFeedback.textContent = 'A√∫n no has conectado todos los puntos. ¬°Sigue intentando!';
        dotsFeedback.style.color = '#F44336';
      }
    });
    
    // Event listener para reiniciar
    resetDotsBtn.addEventListener('click', function() {
      dots.forEach(dot => {
        dot.connected = false;
      });
      connectedDots = [];
      drawDots();
      dotsFeedback.textContent = '';
    });
    
    // Inicializar los puntos
    drawDots();

    // Clasifica por semejanza
    const elementsContainer = document.getElementById('elements-container');
    const dropZones = document.querySelectorAll('.drop-zone');
    const checkClassificationBtn = document.getElementById('check-classification');
    const resetClassificationBtn = document.getElementById('reset-classification');
    const classificationFeedback = document.getElementById('classification-feedback');
    
    // Elementos para clasificar
    const elements = [
      { type: 'circle', color: 'red', group: 1 },
      { type: 'circle', color: 'blue', group: 2 },
      { type: 'circle', color: 'green', group: 3 },
      { type: 'square', color: 'red', group: 1 },
      { type: 'square', color: 'blue', group: 2 },
      { type: 'square', color: 'green', group: 3 },
      { type: 'triangle', color: 'red', group: 1 },
      { type: 'triangle', color: 'blue', group: 2 },
      { type: 'triangle', color: 'green', group: 3 }
    ];
    
    // Funci√≥n para crear los elementos
    function createElements() {
      elementsContainer.innerHTML = '';
      
      elements.forEach((element, index) => {
        const el = document.createElement('div');
        el.className = `classification-element ${element.type} ${element.color}`;
        el.dataset.group = element.group;
        el.draggable = true;
        
        // Event listeners para arrastrar
        el.addEventListener('dragstart', function(e) {
          e.dataTransfer.setData('text/plain', index);
        });
        
        elementsContainer.appendChild(el);
      });
    }
    
    // Event listeners para las zonas de destino
    dropZones.forEach(zone => {
      zone.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      
      zone.addEventListener('drop', function(e) {
        e.preventDefault();
        const elementIndex = e.dataTransfer.getData('text/plain');
        const element = document.querySelectorAll('.classification-element')[elementIndex];
        
        this.appendChild(element);
      });
    });
    
    // Event listener para comprobar la clasificaci√≥n
    checkClassificationBtn.addEventListener('click', function() {
      let correct = true;
      
      dropZones.forEach(zone => {
        const elements = zone.querySelectorAll('.classification-element');
        let group = null;
        
        elements.forEach(element => {
          if (group === null) {
            group = element.dataset.group;
          } else if (group !== element.dataset.group) {
            correct = false;
          }
        });
      });
      
      if (correct) {
        classificationFeedback.textContent = '¬°Correcto! Has agrupado los elementos seg√∫n la ley de similitud.';
        classificationFeedback.style.color = '#4CAF50';
      } else {
        classificationFeedback.textContent = 'Hay elementos que no est√°n correctamente agrupados. ¬°Sigue intentando!';
        classificationFeedback.style.color = '#F44336';
      }
    });
    
    // Event listener para reiniciar la clasificaci√≥n
    resetClassificationBtn.addEventListener('click', function() {
      createElements();
      classificationFeedback.textContent = '';
    });
    
    // Inicializar los elementos
    createElements();

    // Memorama de leyes
    const memoryBoard = document.getElementById('memory-board');
    const memoryAttempts = document.getElementById('memory-attempts');
    const memoryMatches = document.getElementById('memory-matches');
    const resetMemoryBtn = document.getElementById('reset-memory');
    
    // Cartas para el juego
    const memoryCards = [
      { id: 1, type: 'image', law: 'proximidad', content: "{{ url_for('static', filename='images/gestalt_proximity.png') }}" },
      { id: 2, type: 'text', law: 'proximidad', content: 'Ley de Proximidad' },
      { id: 3, type: 'image', law: 'similitud', content: "{{ url_for('static', filename='images/gestalt_similarity.png') }}" },
      { id: 4, type: 'text', law: 'similitud', content: 'Ley de Similitud' },
      { id: 5, type: 'image', law: 'cierre', content: "{{ url_for('static', filename='images/gestalt_closure.png') }}" },
      { id: 6, type: 'text', law: 'cierre', content: 'Ley de Cierre' },
      { id: 7, type: 'image', law: 'continuidad', content: "{{ url_for('static', filename='images/gestalt_continuity.png') }}" },
      { id: 8, type: 'text', law: 'continuidad', content: 'Ley de Continuidad' },
      { id: 9, type: 'image', law: 'figura-fondo', content: "{{ url_for('static', filename='images/gestalt_figure_ground.png') }}" },
      { id: 10, type: 'text', law: 'figura-fondo', content: 'Ley de Figura y Fondo' },
      { id: 11, type: 'image', law: 'simetria', content: "{{ url_for('static', filename='images/gestalt_symmetry.png') }}" },
      { id: 12, type: 'text', law: 'simetria', content: 'Ley de Simetr√≠a' }
    ];
    
    let flippedCards = [];
    let matchedPairs = 0;
    let attempts = 0;
    
    // Funci√≥n para crear el tablero de memoria
    function createMemoryBoard() {
      memoryBoard.innerHTML = '';
      flippedCards = [];
      matchedPairs = 0;
      attempts = 0;
      memoryAttempts.textContent = '0';
      memoryMatches.textContent = '0';
      
      // Mezclar las cartas
      const shuffledCards = [...memoryCards].sort(() => Math.random() - 0.5);
      
      shuffledCards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'memory-card';
        cardElement.dataset.law = card.law;
        cardElement.dataset.id = card.id;
        
        const cardFront = document.createElement('div');
        cardFront.className = 'card-front';
        
        const cardBack = document.createElement('div');
        cardBack.className = 'card-back';
        
        if (card.type === 'image') {
          const img = document.createElement('img');
          img.src = card.content;
          img.alt = card.law;
          cardBack.appendChild(img);
        } else {
          cardBack.textContent = card.content;
        }
        
        cardElement.appendChild(cardFront);
        cardElement.appendChild(cardBack);
        
        cardElement.addEventListener('click', flipCard);
        
        memoryBoard.appendChild(cardElement);
      });
    }
    
    // Funci√≥n para voltear una carta
    function flipCard() {
      if (flippedCards.length === 2) return;
      if (this.classList.contains('flipped') || this.classList.contains('matched')) return;
      
      this.classList.add('flipped');
      flippedCards.push(this);
      
      if (flippedCards.length === 2) {
        attempts++;
        memoryAttempts.textContent = attempts;
        
        setTimeout(checkForMatch, 1000);
      }
    }
    
    // Funci√≥n para comprobar si hay coincidencia
    function checkForMatch() {
      const card1 = flippedCards[0];
      const card2 = flippedCards[1];
      
      if (card1.dataset.law === card2.dataset.law && card1.dataset.id !== card2.dataset.id) {
        card1.classList.add('matched');
        card2.classList.add('matched');
        matchedPairs++;
        memoryMatches.textContent = matchedPairs;
        
        if (matchedPairs === 6) {
          setTimeout(() => {
            alert('¬°Felicidades! Has encontrado todas las parejas.');
          }, 500);
        }
      } else {
        card1.classList.remove('flipped');
        card2.classList.remove('flipped');
      }
      
      flippedCards = [];
    }
    
    // Event listener para reiniciar el juego
    resetMemoryBtn.addEventListener('click', createMemoryBoard);
    
    // Inicializar el juego de memoria
    createMemoryBoard();
  </script>
{% endblock %}